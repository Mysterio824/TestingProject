name: Run Postman API Tests 📦

on:
  push:
    branches: [ main ]

concurrency: production_environment

jobs:
  postman-tests: 
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout ⚙️
        uses: actions/checkout@v4

      - name: Install Newman (Postman CLI)
        run: npm install -g newman

      - name: Run Sign-In tests 🔑
        run: |
          newman run postman/HW07.postman_collection.json \
            --folder "Sign-In" \
            --iteration-data postman/users_login.csv \
            --env-var BASE_API_URL=https://8ce156fd72d6.ngrok-free.app  || echo "Sign-In failed" >> failed_tests.txt

      - name: Run Sign-Up tests 👤
        run: |
          newman run postman/HW07.postman_collection.json \
            --folder "Sign-Up" \
            --iteration-data postman/users_signup.csv \
            --env-var BASE_API_URL=https://8ce156fd72d6.ngrok-free.app  || echo "Sign-Up failed" >> failed_tests.txt

      - name: Run Add-Product tests 📦
        run: |
          newman run postman/HW07.postman_collection.json \
            --folder "Add-Product" \
            --iteration-data postman/products.csv \
            --env-var BASE_API_URL=https://8ce156fd72d6.ngrok-free.app  || echo "Add-Product failed" >> failed_tests.txt

      - name: Check overall result ✅/❌
        run: |
          if [ -f failed_tests.txt ]; then
            echo "Some Postman test suites failed:"
            cat failed_tests.txt
            exit 1
          else
            echo "All Postman test suites passed!"
          fi